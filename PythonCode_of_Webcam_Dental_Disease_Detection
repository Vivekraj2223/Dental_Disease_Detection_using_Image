import cv2
import torch
import torch.nn as nn
from torchvision import transforms
from torchvision.models import mobilenet_v2, MobileNet_V2_Weights
from PIL import Image
import os

# ----------------------------
# DEVICE
# ----------------------------
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
print("Using device:", device)

# ----------------------------
# CLASS NAMES (MUST MATCH TRAINING)
# ----------------------------
class_names = [
    "calculus",
    "caries",
    "gingivitis",
    "mouth_ulcer",
    "tooth_discoloration",
    "hypodontia"
]

# ----------------------------
# MODEL DEFINITION
# ----------------------------
class EnhancedMobileNetV2(nn.Module):
    def __init__(self, num_classes=6):
        super().__init__()
        self.backbone = mobilenet_v2(weights=MobileNet_V2_Weights.IMAGENET1K_V1)
        in_features = self.backbone.classifier[1].in_features

        self.backbone.classifier = nn.Sequential(
            nn.Dropout(0.4),
            nn.Linear(in_features, 1024),
            nn.BatchNorm1d(1024),
            nn.ReLU(),
            nn.Dropout(0.3),
            nn.Linear(1024, num_classes)
        )

    def forward(self, x):
        return self.backbone(x)

# ----------------------------
# LOAD TRAINED MODEL
# ----------------------------
model = EnhancedMobileNetV2(num_classes=len(class_names))
model.load_state_dict(
    torch.load("best_mobilenetv2_oral_disease_FIXED.pth", map_location=device)
)
model.to(device)
model.eval()

print("âœ… Model loaded successfully")

# ----------------------------
# IMAGE TRANSFORM
# ----------------------------
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(
        mean=[0.485, 0.456, 0.406],
        std=[0.229, 0.224, 0.225]
    )
])

# ----------------------------
# PREDICTION FUNCTION
# ----------------------------
def predict_image(pil_img):
    input_tensor = transform(pil_img).unsqueeze(0).to(device)

    with torch.no_grad():
        outputs = model(input_tensor)
        probs = torch.softmax(outputs, dim=1)
        conf, pred = torch.max(probs, dim=1)

    confidence = conf.item()
    predicted_class = class_names[pred.item()]

    # ðŸ”½ LOWER THRESHOLD
    if confidence < 0.30:
        return "Uncertain", confidence
    else:
        return predicted_class, confidence


# ----------------------------
# OPTION 1: WEBCAM DETECTION
# ----------------------------
def webcam_detection():
    cap = cv2.VideoCapture(0)
    print("ðŸ“· Webcam started (Press Q to quit)")

    while True:
        ret, frame = cap.read()
        if not ret:
            break

        rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        pil_img = Image.fromarray(rgb)

        label, confidence = predict_image(pil_img)

        text = f"{label} ({confidence*100:.2f}%)"
        cv2.rectangle(frame, (0, 0), (frame.shape[1], 50), (0, 0, 0), -1)
        cv2.putText(
            frame,
            text,
            (20, 35),
            cv2.FONT_HERSHEY_SIMPLEX,
            1,
            (0, 255, 0),
            2
        )

        cv2.imshow("Dental Disease Detection - Webcam", frame)

        if cv2.waitKey(1) & 0xFF == ord("q"):
            break

    cap.release()
    cv2.destroyAllWindows()

# ----------------------------
# OPTION 2: IMAGE FILE DETECTION
# ----------------------------
def image_file_detection():
    img_path = input("Enter image path: ")

    if not os.path.exists(img_path):
        print("âŒ Image file not found")
        return

    img = Image.open(img_path).convert("RGB")

    # ðŸ‘‡ MODEL PREDICTION
    label, confidence = predict_image(img)

    # ðŸ‘‡ ADD THIS LINE
    print("ðŸ¦· Raw Confidence Value:", confidence)

    print("\nðŸ¦· Prediction Result")
    print("---------------------")
    print("Disease:", label)
    print(f"Confidence: {confidence*100:.2f}%")

    # Show image
    img_cv = cv2.imread(img_path)
    cv2.imshow("Input Image", img_cv)
    cv2.waitKey(0)
    cv2.destroyAllWindows()

# ----------------------------
# MAIN MENU
# ----------------------------
print("\nChoose input method:")
print("1. Webcam")
print("2. Image file")

choice = input("Enter your choice (1 or 2): ")

if choice == "1":
    webcam_detection()
elif choice == "2":
    image_file_detection()
else:
    print("âŒ Invalid choice")
